<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>BONUSIA</title>
</head>

<body>
    <h1>BONUSIA</h1>
    <hr />
    <h2>Transaction Form</h2>
    <form id="transactionForm">

        <label for="user">User:</label>
        <select id="User_name" name="user">
            <!-- Options will be filled dynamically -->
        </select><br><br>

        <label for="type">Transaction Type:</label>
        <select id="TransactionType_name" name="TransactionType_name">
            <!-- Filled dynamically -->
        </select><br><br>


        <label for="amount">Amount:</label>
        <input type="number" id="User_amount" name="amount" required /><br><br>

        <button id="submit" type="submit">Submit</button>
    </form>

    <script>
        // Fetch users and populate the dropdown
        fetch('http://192.168.0.74:7676/get_rows?tableName=User')
            .then(response => response.json())
            .then(data => {
                const userSelect = document.getElementById('User_name');
                const users = data.rows;
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.name;
                    option.textContent = user.name;
                    userSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading users:', error));

        // Populate Transaction Types
        fetch('http://192.168.0.74:7676/get_rows?tableName=TransactionType')
            .then(response => response.json())
            .then(data => {
                const typeSelect = document.getElementById('TransactionType_name');
                data.rows.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.name;
                    option.textContent = type.name;
                    typeSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading transaction types:', error));
    </script>

    <script>
        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const request = {
                User_name: document.getElementById('User_name').value,
                User_amount: parseInt(document.getElementById('User_amount').value, 10),
                TransactionType_name: document.getElementById('TransactionType_name').value,
            };

            let response = await fetch('http://192.168.0.74:7676/transaction', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
            })

            let data = await response.json();

            if (data['status_code'] == 200) {
                alert(`success`);
            }
            else {
                alert(`error: ${data.error}`);
            }
            window.location.reload()
        });
    </script>
    <hr />
    <h2>Balances</h2>
    <div id="userBalances">
        <!-- User balances will be listed here -->
    </div>

    <script>
        // Fetch user balances and display them
        fetch('http://192.168.0.74:7676/get_rows?tableName=User')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('userBalances');
                const users = data.rows;

                users.forEach(user => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                <strong>${user.name}</strong><br>
                Total Balance: ${user.total_balance}<br><br>
              `;
                    container.appendChild(div);
                });
            })
            .catch(error => {
                console.error('Error fetching user balances:', error);
            });
    </script>
    <hr/>
</body>

</html>